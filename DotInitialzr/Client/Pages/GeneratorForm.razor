@page "/"
@inject HttpClient Http
@inject IJSRuntime JSRuntime;

<VMContext VM="GeneratorForm" TState="IGeneratorFormState" OnStateChange="UpdateState">
@if (state != null)
{
    <d-form>
        <d-frame>
            <d-dropdown-list id="Template" />
            <MetadataForm />
            <d-button id="Generate" label="Generate" submit="true" />
        </d-frame>
    </d-form>
}
</VMContext>
@if(state?.Loading == true || loading)
{
    <div class="spinner" />
}

@code {
   private IGeneratorFormState state;
   private bool loading;

   private void UpdateState(IGeneratorFormState state)
   {
       this.state = state;
       if (state.ProjectMetadata != null)
       {
           this.loading = true;
           _ = GenerateAsync(state.ProjectMetadata);
           this.state.ClearProjectMetadata();
       }

       StateHasChanged();
   }

   private async Task GenerateAsync(ProjectMetadata metadata)
   {
       var response = await Http.PostAsJsonAsync("api/generator", state.ProjectMetadata);
       await JSRuntime.InvokeAsync<string>("saveFile", new object[]
       {
           Convert.ToBase64String(await response.Content.ReadAsByteArrayAsync()),
           response.Content.Headers.ContentDisposition.FileName,
           response.Content.Headers.ContentType.ToString()
       });

       this.loading = false;
       StateHasChanged();
   }
}
